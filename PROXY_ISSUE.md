# 代理连接问题排查

## 当前状态

- ✅ 代理端口 7897 可以连接（`Test-NetConnection` 测试通过）
- ✅ 代码已配置代理支持
- ❌ 通过代理连接 OpenAI API 时出现 `ECONNRESET` 错误

## 可能的原因

1. **代理服务器配置问题**
   - 代理工具（如 Clash）可能没有正确配置
   - 代理服务器可能不支持 HTTP CONNECT 隧道
   - 代理服务器可能需要认证

2. **代理协议问题**
   - 当前使用 HTTP 代理，可能需要 SOCKS5
   - 代理工具可能使用不同的协议

3. **代理工具设置**
   - 检查代理工具是否允许本地连接
   - 检查代理工具是否允许 HTTPS 连接
   - 检查代理工具是否有防火墙规则

## 解决方案

### 方案 1：检查代理工具配置

1. **确认代理工具正在运行**
   - 检查 Clash/V2Ray 等代理工具是否正常运行
   - 检查代理工具的日志，看是否有错误

2. **检查代理工具设置**
   - 确认允许本地连接（Allow LAN）
   - 确认 HTTP/HTTPS 代理端口是 7897
   - 检查是否有规则阻止了 OpenAI API

3. **测试代理是否工作**
   - 在浏览器中测试代理是否正常工作
   - 使用代理工具测试 OpenAI API 连接

### 方案 2：尝试不同的代理配置

如果您的代理工具支持 SOCKS5，可以尝试：

```env
# 在 .env 文件中
HTTPS_PROXY=socks5://127.0.0.1:7897
HTTP_PROXY=socks5://127.0.0.1:7897
```

然后需要安装 `socks-proxy-agent`：

```bash
npm install socks-proxy-agent
```

### 方案 3：检查代理工具日志

查看代理工具的日志，看是否有：
- 连接请求
- 错误信息
- 被阻止的请求

### 方案 4：使用系统代理设置

某些代理工具会设置系统代理，Node.js 可能不会自动使用。可以尝试：

1. 检查系统代理设置
2. 使用 `global-agent` 包自动使用系统代理

## 快速测试

运行以下命令测试代理：

```bash
cd backend
node test-proxy.js
```

如果仍然失败，请检查：
1. 代理工具是否正常运行
2. 代理工具的日志
3. 是否需要使用 SOCKS5 协议

## 临时解决方案

如果代理问题无法解决，可以考虑：
1. 使用 VPN 而不是代理
2. 使用支持代理的 OpenAI API 替代方案
3. 在服务器端部署（如果可能）

